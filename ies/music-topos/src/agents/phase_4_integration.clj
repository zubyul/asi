(ns agents.phase-4-integration
  "Phase 4 Integration: Complete Phase 3â†’4 Agent Training Pipeline

  Orchestrates the full flow:
  1. Takes Phase 3 result (patterns, archetypes, training data)
  2. Initializes 9-agent topology in 3Ã—3 Ramanujan configuration
  3. Trains agents on archetype patterns with entropy monitoring
  4. Performs population-level coordination and consensus
  5. Detects novel patterns during training
  6. Prepares output for Phase 5 (surrogate construction)

  Status: 2025-12-21 - Phase 3â†’4 transition ready"
  (:require [agents.phase-4-agent-learning :as phase4]\n            [clojure.string :as str]))

;; =============================================================================
;; Section 1: Complete Phase 3â†’4 Pipeline
;; =============================================================================

(defn run-full-phase-4
  \"Execute complete Phase 3â†’4 transition
   Input: Phase 3 result map with archetypes and training data
   Output: Trained agent population ready for Phase 5\"
  [phase-3-result num-training-generations]

  (println \"\\nâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—\")
  (println \"â•‘    PHASE 4: AGENT-O-RAMA MULTI-AGENT TRAINING           â•‘\")
  (println \"â•‘         (Phase 3â†’4 Integration Pipeline)                 â•‘\")
  (println \"â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\")

  ;; Step 1: Prepare training data from Phase 3
  (let [archetypes (get-in phase-3-result [:archetypes])
        patterns (get-in phase-3-result [:all-data :patterns])
        cluster-map (get-in phase-3-result [:all-data :full-cluster-map])

        ;; Build training sets per archetype
        training-data (reduce (fn [acc [archetype-name archetype]]
                               (let [cluster-id (:cluster-id archetype)
                                     cluster-patterns (get cluster-map cluster-id)
                                     training-set {:archetype-name archetype-name
                                                  :leitmotif (:dominant-leitmotif archetype)
                                                  :num-examples (count cluster-patterns)
                                                  :characteristic-dims (:dimension-means archetype)
                                                  :patterns cluster-patterns}]

                                 (assoc acc archetype-name training-set)))\n                             {}\n                             archetypes)

        ;; Execute Phase 4 training pipeline
        phase-4-result (phase4/run-phase-4 training-data num-training-generations)]\n\n    ;; Generate summary report
    (print-phase-4-summary phase-4-result phase-3-result)\n\n    phase-4-result))\n\n;; =============================================================================
;; Section 2: Summary and Reporting\n;; =============================================================================\n\n(defn print-phase-4-summary\n  \"Print comprehensive Phase 4 summary\"\n  [phase-4-result phase-3-result]\n\n  (let [trained-agents (:trained-agents phase-4-result)\n        pop-metrics (:population-metrics phase-4-result)\n        num-agents (count trained-agents)\n        num-generations (:num-generations pop-metrics)\n        pop-entropy (:entropy pop-metrics)\n        pop-agreement (:agreement pop-metrics)]\n\n    (println \"\\nâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—\")\n    (println \"â•‘       PHASE 4 TRAINING COMPLETE - SUMMARY               â•‘\")\n    (println \"â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\\n\")\n\n    (println \"ğŸ“Š TRAINING PARAMETERS\")\n    (println \"â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\")\n    (println (str \"  Number of agents: \" num-agents))\n    (println (str \"  Topology: Ramanujan 3Ã—3 Expander\"))\n    (println (str \"  Training generations: \" num-generations))\n    (println \"\")\n\n    (println \"ğŸ¯ POPULATION METRICS\")\n    (println \"â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\")\n    (printf \"  Population Entropy: %.3f\\n\" pop-entropy)\n    (printf \"  Agent Agreement: %.1f%%\\n\" (* 100 pop-agreement))\n    (println \"\")\n\n    (println \"ğŸ¤– INDIVIDUAL AGENT STATISTICS\")\n    (println \"â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\")\n    (doseq [agent trained-agents]\n      (printf \"  %s: accuracy=%.1f%%, entropy=%.2f, anomalies=%d\\n\"\n             (:id agent)\n             (* 100 (:recognition-accuracy agent))\n             (:generation-entropy agent)\n             (:anomaly-count agent)))\n    (println \"\")\n\n    (let [avg-accuracy (/ (reduce + (map :recognition-accuracy trained-agents))\n                         (count trained-agents))\n          avg-entropy (/ (reduce + (map :generation-entropy trained-agents))\n                        (count trained-agents))\n          total-anomalies (reduce + (map :anomaly-count trained-agents))]\n\n      (println \"ğŸ“ˆ POPULATION AVERAGES\")\n      (println \"â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\")\n      (printf \"  Average Accuracy: %.1f%%\\n\" (* 100 avg-accuracy))\n      (printf \"  Average Entropy: %.3f\\n\" avg-entropy)\n      (printf \"  Total Anomalies Detected: %d\\n\" total-anomalies))\n    (println \"\")))\n\n;; =============================================================================\n;; Section 3: Prepare for Phase 5 (Surrogate Construction)\n;; =============================================================================\n\n(defn prepare-training-data-for-phase5\n  \"Extract training data from Phase 4 for Phase 5 surrogate construction\n   Returns map with trained agents and learned archetypes\"\n  [phase-4-result phase-3-result]\n\n  (println \"\\nğŸ§  Preparing Training Data for Phase 5 (Surrogate Construction)\")\n  (println \"â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\")\n\n  (let [trained-agents (:trained-agents phase-4-result)\n        archetypes (get-in phase-3-result [:archetypes])\n        patterns (get-in phase-3-result [:all-data :patterns])\n\n        ;; Build Phase 5 training set with agent expertise\n        training-data {:trained-agents trained-agents\n                      :learned-archetypes archetypes\n                      :population-metrics (:population-metrics phase-4-result)\n                      :original-patterns patterns\n                      :num-agents (count trained-agents)}]\n\n    (println (str \"âœ… Prepared Phase 5 training data\"))\n    (println (str \"  Trained agents: \" (count trained-agents)))\n    (println (str \"  Learned archetypes: \" (count archetypes)))\n    (println (str \"  Total patterns: \" (count patterns)))\n    (println \"\")\n\n    training-data))\n\n;; =============================================================================\n;; Section 4: Export Phase 4 Results\n;; =============================================================================\n\n(defn export-phase-4-checkpoint\n  \"Export Phase 4 results as EDN checkpoint for Phase 5\"\n  [phase-4-result export-path]\n\n  (println \"\\nğŸ’¾ EXPORTING PHASE 4 CHECKPOINT\")\n  (println \"â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\")\n  (println (str \"  Export path: \" export-path))\n\n  ;; Create comprehensive checkpoint\n  (let [checkpoint {:phase \"4\"\n                   :timestamp (java.util.Date.)\n                   :trained-agents (:trained-agents phase-4-result)\n                   :population-metrics (:population-metrics phase-4-result)\n                   :agent-topology (:agent-topology phase-4-result)\n                   :phase-3-training-data (:phase-3-training-data phase-4-result)}]\n\n    (try\n      (spit export-path (pr-str checkpoint))\n      (println (str \"âœ… Phase 4 checkpoint saved (\" (count (pr-str checkpoint)) \" bytes)\"))\n      (println \"\")\n      true\n      (catch Exception e\n        (println (str \"âŒ Export failed: \" (.getMessage e)))\n        false))))\n\n(defn export-phase-4-summary\n  \"Export human-readable summary of Phase 4\"\n  [phase-4-result phase-3-result export-path]\n\n  (println \"\\nğŸ“„ EXPORTING PHASE 4 SUMMARY\")\n  (println \"â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\")\n  (println (str \"  Export path: \" export-path))\n\n  (let [trained-agents (:trained-agents phase-4-result)\n        pop-metrics (:population-metrics phase-4-result)\n        archetypes (get-in phase-3-result [:archetypes])\n\n        summary-content\n        (str/join \"\\n\"\n                 [\"â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\"\n                  \"PHASE 4: AGENT-O-RAMA MULTI-AGENT TRAINING REPORT\"\n                  (str \"Generated: \" (java.util.Date.))\n                  \"â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\\n\"\n\n                  \"AGENT TRAINING RESULTS\"\n                  \"â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\"\n                  (str \"Total agents trained: \" (count trained-agents))\n                  (str \"Topology: Ramanujan 3Ã—3 Expander Graph\")\n                  (str \"Training generations: \" (:num-generations pop-metrics))\n                  \"\"\n\n                  \"POPULATION METRICS\"\n                  \"â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\"\n                  (str \"Population Entropy: \" (format \"%.3f\" (:entropy pop-metrics)))\n                  (str \"Agent Agreement: \" (format \"%.1f%%\" (* 100 (:agreement pop-metrics))))\n                  (let [avg-acc (/ (reduce + (map :recognition-accuracy trained-agents))\n                                  (count trained-agents))\n                        avg-ent (/ (reduce + (map :generation-entropy trained-agents))\n                                  (count trained-agents))\n                        total-anom (reduce + (map :anomaly-count trained-agents))]\n                    (str/join \"\\n\"\n                             [(str \"Average Recognition Accuracy: \" (format \"%.1f%%\" (* 100 avg-acc)))\n                              (str \"Average Generation Entropy: \" (format \"%.3f\" avg-ent))\n                              (str \"Total Anomalies Detected: \" total-anom)]))\n                  \"\"\n\n                  \"INDIVIDUAL AGENT PERFORMANCE\"\n                  \"â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\"\n                  (str/join \"\\n\"\n                           (for [agent trained-agents]\n                             (str \"  \" (:id agent)\n                                  \": accuracy=\" (format \"%.1f%%\" (* 100 (:recognition-accuracy agent)))\n                                  \", entropy=\" (format \"%.2f\" (:generation-entropy agent))\n                                  \", anomalies=\" (:anomaly-count agent))))\n                  \"\"\n\n                  \"AGENT SPECIALIZATIONS (FROM PHASE 3 ARCHETYPES)\"\n                  \"â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\"\n                  (str \"Archetypes: \" (count archetypes))\n                  (str/join \"\\n\"\n                           (for [[name archetype] (sort-by key archetypes)]\n                             (str \"  \" name\n                                  \": \" (:size archetype) \" patterns, \"\n                                  \"dominant=\" (name (:dominant-leitmotif archetype)))))\n                  \"\"\n\n                  \"NEXT PHASE (Phase 5)\"\n                  \"â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\"\n                  \"Phase 5 will construct surrogates using:\"\n                  \"  - Trained agents as basis for surrogate blueprints\"\n                  \"  - Learned archetype distributions\"\n                  \"  - Population entropy as diversity metric\"\n                  \"  - Anomaly patterns for novelty detection\"\n                  \"\"])]\n\n    (try\n      (spit export-path summary-content)\n      (println (str \"âœ… Summary exported\"))\n      (println \"\")\n      true\n      (catch Exception e\n        (println (str \"âŒ Export failed: \" (.getMessage e)))\n        false))))\n\n;; =============================================================================\n;; Section 5: Phase 4 Complete Handler\n;; =============================================================================\n\n(defn phase-4-complete\n  \"Mark Phase 4 completion and prepare for Phase 5\n   Returns comprehensive Phase 4 results + Phase 5 prep data\"\n  [phase-4-result\n   phase-3-result\n   {:keys [export-checkpoint-path export-summary-path]\n    :or {export-checkpoint-path nil\n         export-summary-path nil}}]\n\n  (println \"\\nâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—\")\n  (println \"â•‘   PHASE 4 TRAINING COMPLETE - PREPARING PHASE 5        â•‘\")\n  (println \"â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\")\n\n  ;; Export results if paths provided\n  (when export-checkpoint-path\n    (export-phase-4-checkpoint phase-4-result export-checkpoint-path))\n\n  (when export-summary-path\n    (export-phase-4-summary phase-4-result phase-3-result export-summary-path))\n\n  ;; Prepare training data for Phase 5\n  (let [training-data (prepare-training-data-for-phase5 phase-4-result phase-3-result)]\n\n    (println \"\\nâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—\")\n    (println \"â•‘              PHASE 4 STATUS: COMPLETE âœ…               â•‘\")\n    (println \"â•‘           Ready to transition to Phase 5               â•‘\")\n    (println \"â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\\n\")\n\n    {:phase-4-result phase-4-result\n     :phase-5-training-data training-data\n     :status :complete\n     :message \"Phase 4 complete. Phase 5 (surrogate construction) ready to begin.\"}))\n